<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SharePoint Approvals</title>

  <!-- Bootstrap CSS -->
  <link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
  />

  <!-- Bootstrap Icons -->
  <link
	rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />

  <!-- MSAL JS for Microsoft login -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <!-- PDF.js for PDF rendering in modal (Safari-friendly) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
	pdfjsLib.GlobalWorkerOptions.workerSrc =
	  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <style>
	:root {
	  --app-radius: 1rem;
	}

	body {
	  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
	  background: radial-gradient(circle at top left, #0d6efd 0, #6610f2 40%, #0a0c1f 100%);
	  min-height: 100vh;
	  margin: 0;
	  display: flex;
	  align-items: stretch;
	  color: #212529;
	}

	.app-wrapper {
	  flex: 1;
	  padding: 2rem 0;
	}

	.app-card {
	  background: #ffffff;
	  border-radius: var(--app-radius);
	  box-shadow: 0 1.5rem 3.5rem rgba(15, 23, 42, 0.25);
	  padding: 1.75rem 1.75rem 1.5rem;
	  border: 1px solid rgba(15, 23, 42, 0.06);
	}

	.app-header-title {
	  display: flex;
	  align-items: center;
	  gap: 0.75rem;
	}

	.app-header-icon {
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  display: inline-flex;
	  align-items: center;
	  justify-content: center;
	  background: rgba(13, 110, 253, 0.08);
	  color: #0d6efd;
	  font-size: 1.25rem;
	}

	.app-subtitle {
	  letter-spacing: 0.06em;
	  text-transform: uppercase;
	  font-size: 0.75rem;
	  font-weight: 600;
	  color: #6c757d;
	}

	.app-auth-box {
	  display: inline-flex;
	  align-items: center;
	  gap: 0.5rem;
	  padding: 0.4rem 0.75rem;
	  border-radius: 999px;
	  background: rgba(15, 23, 42, 0.03);
	  border: 1px solid rgba(15, 23, 42, 0.06);
	}

	#user-info {
	  font-size: 0.9rem;
	  color: #495057;
	}

	#status {
	  margin-top: 0.35rem;
	  font-style: italic;
	  font-size: 0.85rem;
	  min-height: 1.2rem;
	}

	.status-saving {
	  color: #fd7e14;
	  font-weight: 500;
	}

	.status-saved {
	  color: #198754;
	  font-weight: 500;
	}

	.status-error {
	  color: #dc3545;
	  font-weight: 500;
	}

	/* Icon-based approval controls */
	.status-icon {
	  font-size: 1.3rem;
	  cursor: pointer;
	  margin-right: 0.45rem;
	  transition: transform 0.12s ease, color 0.12s ease, background-color 0.12s ease,
		box-shadow 0.12s ease;
	  border-radius: 999px;
	  padding: 0.22rem;
	  display: inline-flex;
	  align-items: center;
	  justify-content: center;
	}

	.status-icon:last-child {
	  margin-right: 0;
	}

	.status-icon:hover {
	  transform: translateY(-1px) scale(1.06);
	  box-shadow: 0 0.25rem 0.5rem rgba(15, 23, 42, 0.12);
	}

	.status-icon.inactive {
	  color: #adb5bd;
	  background-color: #f1f3f5;
	  opacity: 0.85;
	}

	.status-icon.pending-active {
	  color: #0d6efd;
	  background-color: rgba(13, 110, 253, 0.07);
	}

	.status-icon.approved-active {
	  color: #198754;
	  background-color: rgba(25, 135, 84, 0.07);
	}

	.status-icon.rejected-active {
	  color: #dc3545;
	  background-color: rgba(220, 53, 69, 0.07);
	}

	.approval-legend {
	  font-size: 0.8rem;
	  color: #6c757d;
	  display: flex;
	  align-items: center;
	  flex-wrap: wrap;
	  gap: 0.5rem;
	}

	.approval-legend span {
	  display: inline-flex;
	  align-items: center;
	  gap: 0.25rem;
	}

	.approval-legend .legend-dot {
	  width: 10px;
	  height: 10px;
	  border-radius: 999px;
	  display: inline-block;
	}

	.legend-pending {
	  background-color: #0d6efd;
	}

	.legend-approved {
	  background-color: #198754;
	}

	.legend-rejected {
	  background-color: #dc3545;
	}

	/* Table styling */
	.table-wrapper {
	  margin-top: 1.25rem;
	  border-radius: calc(var(--app-radius) - 0.25rem);
	  overflow: hidden;
	  border: 1px solid rgba(15, 23, 42, 0.06);
	}

	#files-table {
	  margin-bottom: 0;
	  background-color: #ffffff;
	}

	#files-table thead {
	  background: linear-gradient(90deg, #f8f9fa 0, #f1f3f5 50%, #f8f9fa 100%);
	}

	#files-table thead th {
	  font-size: 0.8rem;
	  text-transform: uppercase;
	  letter-spacing: 0.04em;
	  color: #6c757d;
	  border-bottom-width: 1px;
	  border-color: rgba(15, 23, 42, 0.06);
	}

	#files-table tbody tr:hover {
	  background-color: #f8f9ff;
	}

	#files-table tbody td {
	  vertical-align: middle;
	  font-size: 0.9rem;
	}

	#files-table a {
	  text-decoration: none;
	  font-weight: 500;
	  color: #0d6efd;
	}

	#files-table a:hover {
	  text-decoration: underline;
	}

	/* Modal layout: approvals + preview + button */
	#previewModal .modal-dialog {
	  max-width: 1140px;
	}

	#previewModal .modal-content {
	  border-radius: var(--app-radius);
	  box-shadow: 0 1.75rem 3.5rem rgba(15, 23, 42, 0.35);
	  border: 0;
	  overflow: hidden;
	}

	#previewModal .modal-header {
	  border-bottom: 1px solid rgba(15, 23, 42, 0.06);
	  background: linear-gradient(90deg, #0d6efd 0, #6610f2 100%);
	  color: #ffffff;
	}

	#previewModal .modal-title {
	  font-size: 1rem;
	  font-weight: 600;
	}

	#previewModal .btn-close {
	  filter: invert(1) grayscale(100%);
	  opacity: 0.9;
	}

	#previewModal .modal-body {
	  max-height: 80vh;
	  display: flex;
	  flex-direction: column;
	  overflow: hidden;
	  background-color: #f8f9fa;
	}

	#previewTopControls {
	  flex: 0 0 auto;
	  padding: 1rem 1.5rem 0.5rem;
	  background: #ffffff;
	  border-bottom: 1px solid rgba(15, 23, 42, 0.06);
	}

	#previewTopControls .form-label {
	  font-size: 0.75rem;
	  text-transform: uppercase;
	  letter-spacing: 0.06em;
	}

	#previewContainer {
	  flex: 1 1 auto;
	  overflow: auto;
	  padding: 0.75rem 1.5rem 0.75rem;
	  background: radial-gradient(circle at top, #ffffff 0, #f1f3f5 45%, #e9ecef 100%);
	}

	#previewContainer canvas {
	  max-width: 100%;
	  height: auto;
	  display: block;
	  margin: 0 auto;
	  box-shadow: 0 0.75rem 2rem rgba(15, 23, 42, 0.25);
	  border-radius: 0.75rem;
	  background-color: #fff;
	}

	#previewBottomActions {
	  flex: 0 0 auto;
	  padding: 0.75rem 1.5rem 1.25rem;
	  background-color: #ffffff;
	  border-top: 1px solid rgba(15, 23, 42, 0.06);
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  gap: 0.75rem;
	  font-size: 0.85rem;
	  color: #6c757d;
	}

	#previewBottomActions .btn-primary {
	  border-radius: 999px;
	  padding-inline: 1.5rem;
	  display: inline-flex;
	  align-items: center;
	  gap: 0.4rem;
	  font-weight: 500;
	}

	#previewBottomActions .btn-primary i {
	  font-size: 1rem;
	}

	@media (max-width: 768px) {
	  .app-card {
		padding: 1.25rem 1.25rem 1rem;
		border-radius: 0.85rem;
	  }

	  .app-header-title h1 {
		font-size: 1.1rem;
	  }

	  .app-header-icon {
		width: 36px;
		height: 36px;
		font-size: 1.1rem;
	  }

	  .app-auth-box {
		margin-top: 0.75rem;
	  }

	  #previewModal .modal-dialog {
		margin: 0.75rem;
	  }
	}
  </style>
</head>
<body>
  <div class="app-wrapper">
	<div class="container">
	  <div class="app-card">
		<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-3">
		  <div>
			<div class="app-header-title mb-1">
			  <div class="app-header-icon">
				<i class="bi bi-folder2-open"></i>
			  </div>
			  <div>
				<h1 class="h5 mb-0">SharePoint Folder – Approvals</h1>
				<div class="app-subtitle">COMPTABILITÉ · FACTURES MAIL</div>
			  </div>
			</div>
		  </div>

		  <div class="text-md-end">
			<div class="app-auth-box mb-1">
			  <i class="bi bi-shield-lock text-primary"></i>
			  <button id="login-btn" class="btn btn-sm btn-primary px-3">Login with Microsoft 365</button>
			  <button id="logout-btn" class="btn btn-sm btn-outline-secondary px-3" style="display:none;">
				Logout
			  </button>
			</div>
			<div id="user-info" class="mt-1"></div>
		  </div>
		</div>

		<div id="status"></div>

		<div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
		  <div class="approval-legend">
			<span><strong>Approvals</strong>:</span>
			<span><span class="legend-dot legend-pending"></span> Pending</span>
			<span><span class="legend-dot legend-approved"></span> Approved</span>
			<span><span class="legend-dot legend-rejected"></span> Rejected</span>
		  </div>
		</div>

		<div class="table-wrapper mt-3">
		  <div class="table-responsive">
			<table id="files-table" class="table table-hover table-sm align-middle" style="display:none;">
			  <thead class="table-light">
				<tr>
				  <th style="width: 30%;">Name</th>
				  <th style="width: 15%;">Date added</th>
				  <th style="width: 20%;">Project Manager Approval</th>
				  <th style="width: 20%;">Director Approval</th>
				  <th style="width: 15%;">Save Status</th>
				</tr>
			  </thead>
			  <tbody id="files-body"></tbody>
			</table>
		  </div>
		</div>
	  </div>
	</div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title d-flex align-items-center gap-2" id="previewTitle"></h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
		  <!-- Top: approvals inside popup -->
		  <div id="previewTopControls">
			<div class="row g-3">
			  <div class="col-md-6">
				<label class="form-label small text-muted">Project Manager Approval</label>
				<div id="modalPmApproval"></div>
			  </div>
			  <div class="col-md-6">
				<label class="form-label small text-muted">Director Approval</label>
				<div id="modalDirApproval"></div>
			  </div>
			</div>
		  </div>

		  <!-- Middle: PDF preview -->
		  <div id="previewContainer">
			<!-- canvas goes here -->
		  </div>

		  <!-- Bottom: open in new tab button -->
		  <div id="previewBottomActions">
			<div class="text-muted d-none d-md-block">
			  If the preview is not clear, you can open the original document in SharePoint.
			</div>
			<a id="previewOpenNewTab" href="#" target="_blank" class="btn btn-primary">
			  <i class="bi bi-box-arrow-up-right"></i>
			  Open file in new tab
			</a>
		  </div>
		</div>
	  </div>
	</div>
  </div>

  <!-- Bootstrap JS bundle (for modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
	// ======== CONFIG ========
	const msalConfig = {
	  auth: {
		clientId: "fd3ac33d-c123-4bfa-9a8b-75f4c5d428bf",
		authority: "https://login.microsoftonline.com/bc14846d-2d3e-4428-b3c5-35282b90dbcf",
		redirectUri: "https://dev.mediation-sa.lu/sharepoint-approval-app"
	  }
	};

	const spConfig = {
	  hostname: "mediationsa.sharepoint.com",
	  sitePath: "/sites/mediation",
	  folderPath: "COMPTABILITE/FACTURES MAIL"
	};

	const graphScopes = ["Files.ReadWrite.All", "Sites.ReadWrite.All"];

	const msalInstance = new msal.PublicClientApplication(msalConfig);
	let account = null;
	let cachedSiteId = null;
	let currentDriveId = null;

	// We'll store row state by item id so popup and row stay in sync
	const rowStateByItemId = {};

	// ======== AUTH HELPERS ========
	async function login() {
	  try {
		const loginResponse = await msalInstance.loginPopup({ scopes: graphScopes });
		account = loginResponse.account;
		msalInstance.setActiveAccount(account);
		document.getElementById("login-btn").style.display = "none";
		document.getElementById("logout-btn").style.display = "inline-block";
		document.getElementById("user-info").innerText = `Logged in as: ${account.username}`;
		loadFiles();
	  } catch (err) {
		console.error("Login failed", err);
		document.getElementById("status").innerText = "Login failed: " + err.message;
	  }
	}

	function logout() {
	  msalInstance.logoutPopup().then(() => {
		account = null;
		document.getElementById("login-btn").style.display = "inline-block";
		document.getElementById("logout-btn").style.display = "none";
		document.getElementById("user-info").innerText = "";
		document.getElementById("files-table").style.display = "none";
		document.getElementById("status").innerText = "";
	  });
	}

	async function getToken() {
	  const activeAccount = msalInstance.getActiveAccount();
	  if (!activeAccount) throw new Error("No active account – please log in.");

	  try {
		const response = await msalInstance.acquireTokenSilent({
		  scopes: graphScopes,
		  account: activeAccount
		});
		return response.accessToken;
	  } catch (silentError) {
		console.warn("Silent token failed, showing popup", silentError);
		const response = await msalInstance.acquireTokenPopup({ scopes: graphScopes });
		return response.accessToken;
	  }
	}

	// ======== GRAPH HELPERS ========
	async function graphRequest(url, method = "GET", body = null) {
	  const token = await getToken();
	  const headers = {
		"Authorization": `Bearer ${token}`,
		"Accept": "application/json"
	  };
	  if (body) headers["Content-Type"] = "application/json";

	  const res = await fetch(url, {
		method,
		headers,
		body: body ? JSON.stringify(body) : null
	  });

	  if (!res.ok) {
		const text = await res.text();
		console.error("Graph error", res.status, text);
		throw new Error(`Graph error ${res.status}: ${text}`);
	  }
	  return res.json();
	}

	async function getSiteId() {
	  if (cachedSiteId) return cachedSiteId;
	  const { hostname, sitePath } = spConfig;
	  const url = `https://graph.microsoft.com/v1.0/sites/${hostname}:${sitePath}`;
	  const data = await graphRequest(url);
	  cachedSiteId = data.id;
	  return cachedSiteId;
	}

	function encodeFolderPath(path) {
	  return path
		.split("/")
		.map(seg => encodeURIComponent(seg))
		.join("/");
	}

	async function getDriveAndFolderItems(siteId) {
	  const { folderPath } = spConfig;

	  const driveUrl = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive`;
	  const drive = await graphRequest(driveUrl);
	  const driveId = drive.id;
	  currentDriveId = driveId;

	  const encodedPath = encodeFolderPath(folderPath);
	  const folderUrl =
		`https://graph.microsoft.com/v1.0/drives/${driveId}/root:/${encodedPath}:/children`;
	  const children = await graphRequest(folderUrl);

	  return { driveId, items: children.value };
	}

	async function getItemFields(siteId, driveItemId) {
	  const url =
		`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/items/${driveItemId}/listItem/fields`;
	  return graphRequest(url);
	}

	async function updateApprovals(siteId, driveItemId, fieldsToUpdate) {
	  const url =
		`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/items/${driveItemId}/listItem/fields`;
	  return graphRequest(url, "PATCH", fieldsToUpdate);
	}

	// ======== STATUS ICON CONTROL ========
	function createStatusIcons(initialValue, onChange) {
	  const container = document.createElement("div");
	  container.className = "d-flex align-items-center";

	  const states = [
		{
		  value: "Pending",
		  iconClass: "bi-hourglass-split",
		  activeClass: "pending-active"
		},
		{
		  value: "Approved",
		  iconClass: "bi-check-circle-fill",
		  activeClass: "approved-active"
		},
		{
		  value: "Rejected",
		  iconClass: "bi-x-circle-fill",
		  activeClass: "rejected-active"
		}
	  ];

	  let currentValue = initialValue || "Pending";

	  function refresh() {
		for (const icon of container.children) {
		  const stateValue = icon.getAttribute("data-value");
		  icon.classList.remove(
			"inactive",
			"pending-active",
			"approved-active",
			"rejected-active"
		  );
		  if (stateValue === currentValue) {
			icon.classList.add(
			  stateValue === "Pending"
				? "pending-active"
				: stateValue === "Approved"
				? "approved-active"
				: "rejected-active"
			);
		  } else {
			icon.classList.add("inactive");
		  }
		}
	  }

	  for (const st of states) {
		const i = document.createElement("i");
		i.className = `bi ${st.iconClass} status-icon`;
		i.setAttribute("data-value", st.value);
		i.title = st.value;
		i.addEventListener("click", () => {
		  if (currentValue !== st.value) {
			currentValue = st.value;
			refresh();
			if (onChange) onChange(currentValue);
		  }
		});
		container.appendChild(i);
	  }

	  refresh();

	  return {
		element: container,
		getValue: () => currentValue,
		setValue: (v) => {
		  currentValue = v;
		  refresh();
		  if (onChange) onChange(currentValue);
		}
	  };
	}

	// ======== SAVE APPROVALS (shared by row + popup) ========
	async function saveApprovalsForRow(rowState) {
	  if (!rowState) return;
	  const { driveItemId, statusTd, pmControl, dirControl } = rowState;

	  statusTd.textContent = "Saving...";
	  statusTd.className = "status-saving";

	  try {
		const siteId = await getSiteId();
		await updateApprovals(siteId, driveItemId, {
		  ProjectManagerApproval: pmControl.getValue(),
		  DirectorApproval:    dirControl.getValue()
		});
		statusTd.textContent = "Saved";
		statusTd.className = "status-saved";
	  } catch (e) {
		console.error("Update error", e);
		statusTd.textContent = "Error";
		statusTd.className = "status-error";
	  }
	}

	// ======== PREVIEW USING PDF.js + MODAL APPROVAL CONTROLS ========
	async function openPreview(rowState) {
	  const { item, driveItemId, pmControl, dirControl } = rowState;

	  const modalEl = document.getElementById("previewModal");
	  const titleEl = document.getElementById("previewTitle");
	  const openNewTabEl = document.getElementById("previewOpenNewTab");
	  const container = document.getElementById("previewContainer");

	  titleEl.textContent = item.name;
	  const sharepointUrl = item.webUrl || "#";
	  openNewTabEl.href = sharepointUrl;

	  // Setup approval controls in modal
	  const pmHost = document.getElementById("modalPmApproval");
	  const dirHost = document.getElementById("modalDirApproval");
	  pmHost.innerHTML = "";
	  dirHost.innerHTML = "";

	  const pmModalControl = createStatusIcons(pmControl.getValue(), () => {
		// sync row icon and save
		pmControl.setValue(pmModalControl.getValue());
		saveApprovalsForRow(rowState);
	  });
	  const dirModalControl = createStatusIcons(dirControl.getValue(), () => {
		dirControl.setValue(dirModalControl.getValue());
		saveApprovalsForRow(rowState);
	  });

	  pmHost.appendChild(pmModalControl.element);
	  dirHost.appendChild(dirModalControl.element);

	  // Now handle PDF preview
	  container.innerHTML = '<div class="text-muted p-3">Loading preview...</div>';

	  const ext = (item.name.split(".").pop() || "").toLowerCase();
	  const isPdf = ext === "pdf";

	  if (!isPdf || !currentDriveId) {
		container.innerHTML =
		  '<div class="text-muted p-3">No inline preview for this file type. Use "Open file in new tab".</div>';
		const modal = new bootstrap.Modal(modalEl);
		modal.show();
		return;
	  }

	  try {
		const token = await getToken();
		const contentResponse = await fetch(
		  `https://graph.microsoft.com/v1.0/drives/${currentDriveId}/items/${driveItemId}/content`,
		  {
			headers: { Authorization: `Bearer ${token}` }
		  }
		);

		if (!contentResponse.ok) {
		  const text = await contentResponse.text();
		  console.error("Content fetch error", contentResponse.status, text);
		  throw new Error("Cannot fetch file content");
		}

		const blob = await contentResponse.blob();
		const arrayBuffer = await blob.arrayBuffer();

		container.innerHTML = "";
		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");
		container.appendChild(canvas);

		const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
		const pdf = await loadingTask.promise;
		const page = await pdf.getPage(1); // first page

		const unscaledViewport = page.getViewport({ scale: 1.0 });
		const containerWidth = container.clientWidth || 800;
		const scale = containerWidth / unscaledViewport.width;
		const viewport = page.getViewport({ scale });

		canvas.width = viewport.width;
		canvas.height = viewport.height;

		const renderContext = {
		  canvasContext: ctx,
		  viewport: viewport
		};

		await page.render(renderContext).promise;

	  } catch (e) {
		console.error("Preview error", e);
		container.innerHTML =
		  '<div class="text-danger p-3">Cannot display inline preview. Please use "Open file in new tab".</div>';
	  }

	  const modal = new bootstrap.Modal(modalEl);
	  modal.show();
	}

	// ======== MAIN UI LOGIC ========
	async function loadFiles() {
	  const statusDiv = document.getElementById("status");
	  statusDiv.innerText = "Loading files...";
	  document.getElementById("files-body").innerHTML = "";
	  Object.keys(rowStateByItemId).forEach(k => delete rowStateByItemId[k]);

	  try {
		const siteId = await getSiteId();
		const { items } = await getDriveAndFolderItems(siteId);
		const tbody = document.getElementById("files-body");

		for (const item of items) {
		  if (!item.file) continue; // skip folders

		  const driveItemId = item.id;
		  let fields;
		  try {
			fields = await getItemFields(siteId, driveItemId);
		  } catch (err) {
			console.warn("Could not get fields for item", item.name, err);
			continue;
		  }

		  const pmValue = fields.ProjectManagerApproval || "Pending";
		  const dirValue = fields.DirectorApproval || "Pending";

		  const tr = document.createElement("tr");

		  // Name (clickable for preview)
		  const nameTd = document.createElement("td");
		  const nameLink = document.createElement("a");
		  nameLink.href = "#";
		  nameLink.textContent = item.name;
		  nameTd.appendChild(nameLink);
		  tr.appendChild(nameTd);

		  // Date added
		  const dateTd = document.createElement("td");
		  const created = item.createdDateTime ? new Date(item.createdDateTime) : null;
		  dateTd.textContent = created ? created.toLocaleDateString() : "";
		  tr.appendChild(dateTd);

		  // Approval cells + status
		  const pmTd = document.createElement("td");
		  const dirTd = document.createElement("td");
		  const statusTd = document.createElement("td");
		  tr.appendChild(pmTd);
		  tr.appendChild(dirTd);
		  tr.appendChild(statusTd);

		  // Row-level status icons
		  const pmControl = createStatusIcons(pmValue, () => saveApprovalsForRow(rowStateByItemId[driveItemId]));
		  const dirControl = createStatusIcons(dirValue, () => saveApprovalsForRow(rowStateByItemId[driveItemId]));
		  pmTd.appendChild(pmControl.element);
		  dirTd.appendChild(dirControl.element);

		  // Build row state so popup and row share it
		  const rowState = {
			item,
			driveItemId,
			pmControl,
			dirControl,
			statusTd
		  };
		  rowStateByItemId[driveItemId] = rowState;

		  // Name click opens preview with that row state
		  nameLink.addEventListener("click", (e) => {
			e.preventDefault();
			openPreview(rowState);
		  });

		  tbody.appendChild(tr);
		}

		document.getElementById("files-table").style.display = "table";
		statusDiv.innerText = `Loaded ${tbody.children.length} file(s).`;
	  } catch (e) {
		console.error("loadFiles error", e);
		statusDiv.innerText = "Error loading files: " + e.message;
	  }
	}

	// ======== WIRE UI ========
	document.getElementById("login-btn").addEventListener("click", login);
	document.getElementById("logout-btn").addEventListener("click", logout);

	const accounts = msalInstance.getAllAccounts();
	if (accounts && accounts.length > 0) {
	  account = accounts[0];
	  msalInstance.setActiveAccount(account);
	  document.getElementById("login-btn").style.display = "none";
	  document.getElementById("logout-btn").style.display = "inline-block";
	  document.getElementById("user-info").innerText = `Logged in as: ${account.username}`;
	  loadFiles();
	}
  </script>
</body>
</html>
